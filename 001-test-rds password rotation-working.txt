name: RDS User Password Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - rotate user password
        default: "rotate user password"

      # AWS credentials
      AWS_ACCESS_KEY_ID:
        description: "AWS Access Key ID"
        required: true
      AWS_SECRET_ACCESS_KEY:
        description: "AWS Secret Access Key"
        required: true
      AWS_SESSION_TOKEN:
        description: "AWS Session Token"
        required: true

      # Normal user parameters
      normal_client_name:
        description: "Normal client name"
        required: true
        default: "san"
      normal_environment:
        description: "Normal environment"
        required: true
        default: "qa"
      normal_secret_name:
        description: "Normal user secret name"
        required: true
        default: "value1"

      # Key mapping for normal user secret
      username_key:
        description: "Key to use for username/id (id or username)"
        required: true
        default: "id"
      password_key:
        description: "Key to use for password/secret (password or secret)"
        required: true
        default: "secret"

jobs:
  rotate-user-password:
    runs-on: sir-common-runner-ec2
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo dnf install -y jq postgresql16

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ github.event.inputs.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ github.event.inputs.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ github.event.inputs.AWS_SESSION_TOKEN }}
          aws-region: eu-west-1

      # --- Master Secret (HARD-CODED) ---
      - name: Retrieve master DB secret
        id: get_master_secret
        run: |
          SECRET_PATH="/san/qa/psql/master"
          echo "Fetching master secret from: $SECRET_PATH"

          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "$SECRET_PATH" \
            --query SecretString \
            --output text)

          DB_USER=$(echo $SECRET_JSON | jq -r '.id // .username')
          DB_PASSWORD=$(echo $SECRET_JSON | jq -r '.secret // .password')
          DB_HOST=$(echo $SECRET_JSON | jq -r '.host')

          if [ -z "$DB_USER" ] || [ -z "$DB_PASSWORD" ] || [ -z "$DB_HOST" ]; then
            echo "❌ Master secret is missing required fields"
            exit 1
          fi

          echo "::add-mask::$DB_PASSWORD"
          echo "db_host=$DB_HOST" >> $GITHUB_OUTPUT
          echo "master_user=$DB_USER" >> $GITHUB_OUTPUT
          echo "master_password=$DB_PASSWORD" >> $GITHUB_OUTPUT

      # --- Normal User Secret ---
      - name: Retrieve normal user secret
        id: get_normal_secret
        run: |
          SECRET_PATH="/${{ github.event.inputs.normal_client_name }}/${{ github.event.inputs.normal_environment }}/${{ github.event.inputs.normal_secret_name }}"
          echo "Fetching normal user secret from: $SECRET_PATH"

          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "$SECRET_PATH" \
            --query SecretString \
            --output text)

          DB_USER=$(echo $SECRET_JSON | jq -r ".[\"${{ github.event.inputs.username_key }}\"]")
          DB_PASSWORD=$(echo $SECRET_JSON | jq -r ".[\"${{ github.event.inputs.password_key }}\"]")

          if [ -z "$DB_USER" ] || [ -z "$DB_PASSWORD" ]; then
            echo "❌ Normal secret is missing required fields"
            exit 1
          fi

          echo "::add-mask::$DB_PASSWORD"
          echo "normal_user=$DB_USER" >> $GITHUB_OUTPUT
          echo "normal_password=$DB_PASSWORD" >> $GITHUB_OUTPUT

      # --- Rotate Normal User Password ---
      - name: Rotate normal user password in RDS
        env:
          PGPASSWORD: ${{ steps.get_master_secret.outputs.master_password }}
        run: |
          NEW_PASSWORD="${{ steps.get_normal_secret.outputs.normal_password }}"
          NORMAL_USER="${{ steps.get_normal_secret.outputs.normal_user }}"

          echo "Updating password for user $NORMAL_USER..."
          psql --host="${{ steps.get_master_secret.outputs.db_host }}" \
               --username="${{ steps.get_master_secret.outputs.master_user }}" \
               --dbname="postgres" \
               --command="ALTER USER \"$NORMAL_USER\" WITH PASSWORD '$NEW_PASSWORD';"

      # --- Verify Password Change ---
      - name: Verify password change
        env:
          PGPASSWORD: ${{ steps.get_normal_secret.outputs.normal_password }}
        run: |
          NORMAL_USER="${{ steps.get_normal_secret.outputs.normal_user }}"

          echo "Verifying password for user $NORMAL_USER..."
          set +e
          psql --host="${{ steps.get_master_secret.outputs.db_host }}" \
               --username="$NORMAL_USER" \
               --dbname="postgres" \
               --command="\q"
          if [ $? -eq 0 ]; then
            echo "✅ Password change verified successfully"
          else
            echo "❌ Password change verification failed"
            exit 1
          fi
