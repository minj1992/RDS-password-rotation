name: Connect to AWS and PostgreSQL

on:
  workflow_dispatch:
    inputs:
      new_db_user:
        description: 'Username for the new PostgreSQL user to be created'
        required: true
        type: string
        default: 'testuser'
jobs:
  connect-and-query-db:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (jq and psql)
        run: |
          # Use sudo to install packages on the self-hosted runner
          # This assumes a Debian/Ubuntu-based Linux distribution
          sudo apt-get update -y
          sudo apt-get install -y jq postgresql-client

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get DB credentials from AWS Secrets Manager
        id: get_secret
        run: |
          # Fetch the secret. The result is a JSON object where the secret's
          # key-value pairs are inside a JSON string in the 'SecretString' field.
          SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id /sample/test/value7 --query SecretString --output text)

          # Use jq to parse the JSON string and extract the values.
          # The '<<-EOF' syntax allows us to pass a multi-line string to a command.
          # We are setting the values as output parameters for the next step.
          echo "db_host=$(echo $SECRET_JSON | jq -r .host)" >> $GITHUB_OUTPUT
          echo "db_user=$(echo $SECRET_JSON | jq -r .master_user)" >> $GITHUB_OUTPUT
          echo "db_password=$(echo $SECRET_JSON | jq -r .password)" >> $GITHUB_OUTPUT

      - name: Connect to PostgreSQL and show version
        env:
          # PGPASSWORD is the standard environment variable for the psql client password.
          # This is more secure than passing the password on the command line.
          PGPASSWORD: ${{ steps.get_secret.outputs.db_password }}
        run: |
          echo "Connecting to PostgreSQL instance..."
          
          # Use the credentials from the previous step to connect.
          # The '-c' flag executes a single command and exits.
          # We connect to the default 'postgres' database to run the query.
          psql --host="${{ steps.get_secret.outputs.db_host }}" \
               --username="${{ steps.get_secret.outputs.db_user }}" \
               --dbname="postgres" \
               --command="SELECT version();"

      - name: List existing PostgreSQL users
        env:
          PGPASSWORD: ${{ steps.get_secret.outputs.db_password }}
        run: |
          echo "--- Existing Users ---"
          psql --host="${{ steps.get_secret.outputs.db_host }}" \
               --username="${{ steps.get_secret.outputs.db_user }}" \
               --dbname="postgres" \
               --command="\du"

      - name: Create new PostgreSQL user
        env:
          PGPASSWORD: ${{ steps.get_secret.outputs.db_password }}
          # The username is taken from the workflow_dispatch input
          NEW_USER: ${{ github.event.inputs.new_db_user }}
        run: |
          echo "Creating user: $NEW_USER"
          # Generate a secure, random password for the new user
          NEW_PASSWORD=$(openssl rand -base64 16)
          echo "::add-mask::$NEW_PASSWORD"
          echo "Generated Password for $NEW_USER: $NEW_PASSWORD"
          psql --host="${{ steps.get_secret.outputs.db_host }}" \
               --username="${{ steps.get_secret.outputs.db_user }}" \
               --dbname="postgres" \
               --command="CREATE USER \"$NEW_USER\" WITH PASSWORD '$NEW_PASSWORD';"
